<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil - Pawfolio</title>
    <link rel="stylesheet" href="src/style.css">
</head>
<body>
    <a href="index.html" class="back-button">
        <span>‚óÄ</span>
        <span>Volver</span>
    </a>

    <div class="container" id="profileContainer">
        <div class="loading">Cargando perfil...</div>
    </div>

    <div id="imageModal" class="modal" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-close" onclick="closeModal(event)">√ó</div>
            <div class="modal-prev" onclick="changeImage(event, -1)">‚Äπ</div>
            <img id="modalImage" class="modal-image" src="" alt="Imagen ampliada">
            <div class="modal-next" onclick="changeImage(event, 1)">‚Ä∫</div>
            <div class="gallery-counter" id="galleryCounter" style="display: none;"></div>
        </div>
    </div>

    <script src="pets-data.js"></script>
    <script>
        let currentPet = null;
        let currentImageIndex = 0;
        let isProfileImage = false;
        
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;

        function getPetIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('pet');
        }

        function findPetById(id) {
            return petsData.pets.find(pet => pet.id === id);
        }

        function updateCSSVariables(pet) {
            document.documentElement.style.setProperty('--color-principal', pet.colorPrincipal);
            document.documentElement.style.setProperty('--color-secundario', pet.colorSecundario);
            document.documentElement.style.setProperty('--gradiente-inicio', pet.gradienteInicio);
            document.documentElement.style.setProperty('--gradiente-fin', pet.gradienteFin);
        }

        function renderProfile(pet) {
            document.title = `${pet.nombre} - Pawfolio`;
            updateCSSVariables(pet);

            const container = document.getElementById('profileContainer');
            
            container.innerHTML = `
                <header class="profile-header">
                    <div class="profile-image-container" onclick="openProfileImageModal()">
                        <img src="${pet.imagenPerfil}" alt="${pet.nombre}" class="profile-image">
                    </div>
                    <div>
                        <div class="profile-title">
                            <h1 class="profile-name">${pet.nombre}</h1>
                        </div>
                        <span class="profile-breed">${pet.tipo}</span>
                    </div>
                </header>

                <div class="info-grid">
                    ${renderSobreMi(pet)}
                    ${renderPersonalidad(pet)}
                    ${renderSalud(pet)}
                    ${renderNotas(pet)}
                    ${renderGaleria(pet)}
                </div>
            `;
        }

        function renderSobreMi(pet) {
            return `
                <div class="info-card">
                    <h2><span class="info-card-icon">üìã</span> Sobre M√≠</h2>
                    <p>${pet.sobreMi}</p>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value">${pet.estadisticas.edad}</span>
                            <span class="stat-label">${pet.estadisticas.unidadEdad}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${pet.estadisticas.peso}</span>
                            <span class="stat-label">Peso</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">${pet.estadisticas.energia}</span>
                            <span class="stat-label">Energ√≠a</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPersonalidad(pet) {
            const favoritosHTML = pet.personalidad.favoritos.map(fav => `
                <div class="favorite-compact-item">
                    <span class="favorite-icon">${fav.icono}</span>
                    <span class="favorite-text">${fav.texto}</span>
                </div>
            `).join('');

            return `
                <div class="info-card">
                    <h2><span class="info-card-icon">‚≠ê</span> Personalidad y Favoritos</h2>
                    <p class="personality-description">${pet.personalidad.descripcion}</p>
                    <div class="favorites-compact">
                        ${favoritosHTML}
                    </div>
                </div>
            `;
        }

        function renderSalud(pet) {
            const vacunasHTML = pet.salud.vacunas.map(vac => `
                <div class="health-item">
                    <span class="health-name">${vac.nombre}</span>
                    <span class="health-status status-ok">‚úì Al d√≠a</span>
                </div>
            `).join('');

            const desparasitacionHTML = pet.salud.desparasitacion.map(des => `
                <div class="health-item">
                    <span class="health-name">${des.nombre}</span>
                    <span class="health-status status-ok">‚úì Al d√≠a</span>
                </div>
            `).join('');

            return `
                <div class="info-card">
                    <h2><span class="info-card-icon">üíâ</span> Salud y Cuidados</h2>
                    <div class="health-section">
                        <h3 class="health-subtitle">Vacunas</h3>
                        <div class="health-list">
                            ${vacunasHTML}
                        </div>
                    </div>
                    <div class="health-section">
                        <h3 class="health-subtitle">Desparasitaci√≥n</h3>
                        <div class="health-list">
                            ${desparasitacionHTML}
                        </div>
                    </div>
                    <div class="next-appointment">
                        <strong>üìÖ Pr√≥xima cita:</strong> ${pet.salud.proximaCita}
                    </div>
                </div>
            `;
        }

        function renderNotas(pet) {
            const notasHTML = pet.notas.map(nota => `
                <div class="note-item">
                    <span class="note-icon">${nota.icono}</span>
                    <p><strong>${nota.titulo}:</strong> ${nota.descripcion}</p>
                </div>
            `).join('');

            return `
                <div class="info-card">
                    <h2><span class="info-card-icon">‚ö†Ô∏è</span> Notas Importantes</h2>
                    <div class="notes-list">
                        ${notasHTML}
                    </div>
                </div>
            `;
        }

        function renderGaleria(pet) {
            const galeriaHTML = pet.galeria.map((img, index) => `
                <div class="gallery-item" onclick="openModal(${index})">
                    <img src="${img.thumb}" alt="${img.alt}">
                </div>
            `).join('');

            return `
                <div class="info-card" style="grid-column: 1 / -1;">
                    <h2><span class="info-card-icon">üì∏</span> Mi Galer√≠a</h2>
                    <div class="gallery-grid">
                        ${galeriaHTML}
                    </div>
                </div>
            `;
        }

        function updateGalleryCounter() {
            const counter = document.getElementById('galleryCounter');
            if (isProfileImage) {
                counter.style.display = 'none';
            } else {
                counter.style.display = 'block';
                counter.textContent = `${currentImageIndex + 1} / ${currentPet.galeria.length}`;
            }
        }

        function openModal(index) {
            isProfileImage = false;
            currentImageIndex = index;
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            const img = currentPet.galeria[currentImageIndex];
            modalImage.src = img.full;
            modalImage.alt = img.alt;
            
            document.querySelector('.modal-prev').style.display = 'flex';
            document.querySelector('.modal-next').style.display = 'flex';
            
            updateGalleryCounter();
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function openProfileImageModal() {
            isProfileImage = true;
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            
            const profileImageUrl = currentPet.imagenPerfil.replace('w=600&h=600', 'w=1200&h=1200');
            modalImage.src = profileImageUrl;
            modalImage.alt = `${currentPet.nombre} - Foto de perfil`;
            
            document.querySelector('.modal-prev').style.display = 'none';
            document.querySelector('.modal-next').style.display = 'none';
            
            updateGalleryCounter();
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(event) {
            if (event.target.id === 'imageModal' || event.target.className === 'modal-close') {
                const modal = document.getElementById('imageModal');
                modal.classList.remove('active');
                document.body.style.overflow = 'auto';
                
                isProfileImage = false;
            }
        }

        function changeImage(event, direction) {
            if (isProfileImage) return;
            
            event.stopPropagation();
            currentImageIndex += direction;
            
            if (currentImageIndex < 0) {
                currentImageIndex = currentPet.galeria.length - 1;
            } else if (currentImageIndex >= currentPet.galeria.length) {
                currentImageIndex = 0;
            }
            
            const modalImage = document.getElementById('modalImage');
            modalImage.style.opacity = '0';
            
            setTimeout(() => {
                const img = currentPet.galeria[currentImageIndex];
                modalImage.src = img.full;
                modalImage.alt = img.alt;
                modalImage.style.opacity = '1';
                
                updateGalleryCounter();
            }, 150);
        }

        function handleTouchStart(event) {
            touchStartX = event.changedTouches[0].screenX;
            touchStartY = event.changedTouches[0].screenY;
        }

        function handleTouchEnd(event) {
            touchEndX = event.changedTouches[0].screenX;
            touchEndY = event.changedTouches[0].screenY;
            handleSwipe();
        }

        function handleSwipe() {
            if (isProfileImage) return;
            
            const modal = document.getElementById('imageModal');
            if (!modal.classList.contains('active')) return;
            
            const swipeThreshold = 50;
            const deltaX = touchEndX - touchStartX;
            const deltaY = touchEndY - touchStartY;
            
            if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > swipeThreshold) {
                if (deltaX > 0) {
                    changeImage(new Event('swipe'), -1);
                } else {
                    changeImage(new Event('swipe'), 1);
                }
            }
        }

        document.addEventListener('touchstart', handleTouchStart, false);
        document.addEventListener('touchend', handleTouchEnd, false);

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const modal = document.getElementById('imageModal');
                if (modal.classList.contains('active')) {
                    modal.classList.remove('active');
                    document.body.style.overflow = 'auto';
                    isProfileImage = false;
                }
            }
        });

        document.addEventListener('keydown', function(event) {
            const modal = document.getElementById('imageModal');
            if (modal.classList.contains('active')) {
                if (!isProfileImage) {
                    if (event.key === 'ArrowLeft') {
                        changeImage(event, -1);
                    } else if (event.key === 'ArrowRight') {
                        changeImage(event, 1);
                    }
                }
            }
        });

        const petId = getPetIdFromURL();
        if (petId) {
            currentPet = findPetById(petId);
            if (currentPet) {
                renderProfile(currentPet);
            } else {
                document.getElementById('profileContainer').innerHTML = `
                    <div class="loading">Mascota no encontrada</div>
                `;
            }
        } else {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>